<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <title>bitly | Chrome Extension Background</title>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta name="keywords" content="bit.ly, awesome, ladies love outlaws" />
        <meta name="description" content="Shorten and Share, right from your browser, instantly" />
    
    </head>
    <body>
        <div id="container">
            
            <!-- <div id="top">
            </div> <!-- end #top --> -->
            <div id="middle">
                <textarea id="instant_clipboad_copy_space"></textarea>
            </div> <!-- END #middle -->
            <div id="bottom">
                    <div id="escape_worker"></div>
            </div> <!-- end #bottom -->
        
        </div> <!-- end #container -->
        
        <!-- compress and build these?????? -->
        <script type="text/javascript" src="js/bitlyapi-v3.0.js"></script>
        <!-- //*this file does NOT appear in GIT, you will have to manually add the correct credentials* -->
        <script type="text/javascript" src="js/bitly_oauth_credentials.js"></script>  
        <script type="text/javascript" src="js/bExt/bExt.js"></script>
        <script type="text/javascript" src="js/sqldb-v1.0.js"></script>
        <script type="text/javascript" src="js/libs/md5.js"></script>
        <script type="text/javascript" src="js/libs/bg_common.js"></script>
        <script type="text/javascript" src="js/libs/bg_getset_common.js"></script>        
        
        <script type="text/javascript" src="js/libs/common.js"></script>
        <script type="text/javascript" src="js/libs/bitNote.js"></script>
        <script type="text/javascript" charset="utf-8" src="js/libs/expand_thirdparty.js"></script>
        <script type="text/javascript" charset="utf-8">

        
        // for use with expand_and_meta
        
        function sign_in(username, password, callback) {
            logger("auth attempt for", username)
            bitly.auth(username, password, function(response) {
                
                var auth = response;
                if(auth && auth.login !== "" ) {
                    var current_user = {
                        "x_login": auth.login,
                        "x_apiKey": auth.apiKey,
                        "access_token" : auth.access_token
                    }
                    save_signedin_user( current_user );
                    fetch_all_domains();
                    initilaize_with_signin_info();
                }
                if(callback) { callback(response); }
            
            });
        }
        
        
        function sign_out() {
            bitly.remove_credentials();
            auto_expand_urls = true;
            enhance_twitter_com=true;
            
            reset_local_data();
            bitly.set_domain("bit.ly");
            chrome.browserAction.setPopup({ "popup" : ""});
            return;
        }
                

        

        
        
        // calls bit.ly, so has to say here for a moment until we clear up dependencies 
        // the ISSUE
        // is that user credentials are getting stored POORLY
        // this makes it required to ask the bitly object for information
        // while this makes sense, it's a global object
        // .... 

        // Start the App controls
        function init_api() {
            // get from local storage?
            // pull this value from a settings file
            if(!bitly_oauth_credentials) {
                console.log("a required file is missing! please add a valid js/bitly_oauth_credentials.js")
                throw "MISSING_CREDENTIALS_FILE";
            }
            var b = bitlyAPI( bitly_oauth_credentials.client_id, bitly_oauth_credentials.client_signature );
            return b;
        }
        function init_db( name ) {
            return sqlDB("bitly_local_db");
        }
        
        function test_metrics() {
            // clicks|country|referrers
            bitly.metrics("clicks", function(jo) {
                // need to send param: days=40, days:2, days:5
                console.log("clicks", jo);
            });
            
            bitly.metrics("countries", function(jo) {
                console.log("country", jo)
            });
            
            bitly.metrics("referrers", function(jo) {
                console.log("referrers", jo)
            });
        }
        
        /////////////////////////////////////////////////////////////
        /// START UP the Chrome Extension Application..
        /*
            Variable Information
                bitly -- the global variable and interface to the bit.ly API
                            Options like, user Auth Key, oAuthToken are stored here
                        
                        Make methods available to api.bitly.com 
                        
                bit_db -- the global variable for the SQL Lite interface
                
                trends_worker -- a long running worker process that checks 
                                    for currently trending USER links
                                    This is a 'short' poll SSL interface
                                    
                domains_list  -- bit.ly what label domains to check against to avoid unneeded lookups
                                    Resolves issues with incorrectly expanding non bit.ly domains
        
        */
        logger("Initialize bit.ly extension");
        // the bit.ly API connector, db interface and other global variables        
        var bitly=init_api(), bit_db=init_db(), 
            trends_worker, domains_list, 
            auto_expand_urls = true, enhance_twitter_com=true, context_menu_added=false, notify_on_context_menu=false,
            // for google tracking, when that's ready
            _gaq = _gaq || [];
        
        // Initialize Cache Items
        expire_old_blacklist();        
        trends_worker = new Worker("js/workers/realtime_data.js");
        trends_worker.onmessage = trends_worker_message_event;
        
        // derive items from cache
        initialize_data_from_local_cache();
        
        
        
        /*
            Listen for requests from content scripts, popups and other pages etc
                Party Line, everyone is talking
                    Everyone is invited....
        */
          
          
          

        console.log("new structure bExt.Eventer");
        var bitly_listen=new bExt.Eventer();
        
        var chrome_actions={
            "page_loaded" : function(r, s, sr) {
                // incomplete
                console.log("the brain hears you in bitly_listen");
                this._add_js( s.tab.id, "js/content_plugins/bitly.enhance_twitter.js" );
                return;
            },
            "share" : function() {
                console.log("share share")
            }
        }
        
        bitly_listen.register(null, chrome_actions);
        
        bitly_listen.chrome_listen();
        
        
        
        function actions_listeners( request, sender, sendResponse ) {
            if(!request.action) return;
            var act = request.action;
            switch( act ) {
                
                case "page_loaded":
                    
                    var user_data = localfetch("user_data");
                    /*
                        Makes determination if used is logged in, toggles 'popup' behavior accordingly
                            Default popup behavior is to load options.html, login page
                    */

                    if(user_data && user_data.x_login && user_data.x_apiKey) {
                        if(enhance_twitter_com && request.domain_host === "twitter.com" ) {

                            chrome.tabs.executeScript(sender.tab.id, {file: "js/content_plugins/bitly.enhance_twitter.js"});                        
                        }

                        if(!bitly.is_authenticated() || !auto_expand_urls) return; // the bail out...
                        var injectTabs = sender.tab && sender.tab.url,
                            no_expand_list = get_no_expand_domains();

                        // only support http || https domains
                        if(injectTabs && injectTabs.indexOf("http") === 0 &&
                            no_expand_list.indexOf( request.domain_host ) === -1) {

                                chrome.tabs.insertCSS(sender.tab.id, {file : "css/urlexpander.css"})
                                chrome.tabs.executeScript(sender.tab.id, {file: "js/content_plugins/bitly.urlexpander.js"});
                        }                    
                    }                    
                    

                break;
                
                /*
                    Social Actions, sharing, accounts etc
                */
                case "share":
                    //share_text
                    share_message( (request.share_text || ""),  sendResponse );
                break;
                
                case "share_accounts":
                    var user_share_accounts = localfetch("share_accounts");
                    if(!user_share_accounts) {
                        sharing_resync_linked_account( sendResponse );
                    } else {
                        sendResponse( user_share_accounts )
                    }
                
                break;
                
                case "re_sync_share_accounts":
                    sharing_resync_linked_account( sendResponse );
                break;
                
                case "activate_account":
                    var user_share_accounts = localfetch("share_accounts"),
                        accounts = user_share_accounts && user_share_accounts.share_accounts,
                        i=0, account, flag=false;
                    
                    for( ; account=accounts[i]; i++) {
                        if(account.account_id === request.account_id) {
                            account.active = request.active;
                            flag = true;
                            break;
                        }
                    }
                    localstore("share_accounts", user_share_accounts);
                    sendResponse(user_share_accounts)
                
                break;
                
                /*
                    Core bit.ly, clicks, expands shortens etc
                */
                case "expand_and_meta":
                    
                    parse_domains( request.short_url )
                    var sUrl = (typeof request.short_url !== "string") ? request.short_url : [request.short_url],
                        expand_url_list =  process_domains( sUrl ),
                        lngth = expand_url_list.length;
                    //logger("Attempt expand and find clicks for #" + lngth + " links" )
                    bitly.expand_and_meta( expand_url_list, sendResponse );
                
                break;
                
                case "shorten_and_select":
                    logger("Shorten request");
                    if(request.long_url.indexOf("http") === 0) {
                        chrome.tabs.executeScript(request.tab_id, {file: "js/content_plugins/getSelected.js"});
                    }
                    // could be more selective about shortens, but leaving open for ftp urls etc
                    bitly.shorten( request.long_url, sendResponse );
                break;
                
                case "shorten":
                    console.log("shorten these..");
                    // see if this is an object..
                    // loop over it
                    // check the white list for this url... ouch expensive... go other way?
                    // loop over HUGE whitelist set, check smaller 'long url' domains -- common method for doing this?
                    // shorten them, get a response, send back
                    if(request.long_url) {
                        bitly.shorten( request.long_url, sendResponse );                        
                    }
                break;
                
                case "realtime_metrics":
                    get_realtime_metrics( sendResponse );
                break;
                
                case "expand":
                    bitly.expand( request.short_url, sendResponse );
                break;
                
                case "lookup":
                    bitly.lookup( request.long_url, sendResponse );
                break;
                
                case "page_select":
                    if(request.long_url.indexOf("http") === 0) {
                        chrome.tabs.executeScript(request.tab_id, {file: "js/content_plugins/getSelected.js"});
                    }
                break;
                
                
                /*
                    Misc Actions
                */
                case "open_options":
                    // this is primary used for content scripts
                    get_chrome_page("options.html");
                break;
                
                case "add_no_expand_domain_and_reload":
                    request.domain_host
                    if(request.domain_host && request.domain_host !== "") {
                        add_no_expand_domain( request.domain_host );
                        get_chrome_page("options.html");
                    }
                break;
            
            }
        }
        
        
        /*
            Support for external shortens?
            http://code.google.com/chrome/extensions/extension.html
            chrome.extension.onConnectExternal.addListener(function(Port port) {...});
        */
        
        
        function browser_action_listener( curr_tab ) {
            // if popup is NOT set, this event will be triggered
            get_chrome_page("options.html");
        }        
        chrome.extension.onRequest.addListener(actions_listeners);
        if( !chrome.browserAction.onClicked.hasListener( browser_action_listener ) ) {
            chrome.browserAction.onClicked.addListener( browser_action_listener );
        }
        
        
        /*
            TODO
            // do not implement this!
            
            analytics init
                this is broken on Google's side
                http://code.google.com/chrome/extensions/trunk/tut_analytics.html
        */
        
        // _gaq.push(['_setAccount', 'UA-XXXXXX-X']);
        // _gaq.push(['_trackPageview']);
        //
        // (function() {
        //   var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        //   ga.src = 'https://ssl.google-analytics.com/ga.js';
        //   (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ga);
        // })();
        
        </script>
    
    </body>
</html>

