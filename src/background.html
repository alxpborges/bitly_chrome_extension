<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <title>bitly | Chrome Extension Background</title>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta name="keywords" content="bit.ly, awesome, ladies love outlaws" />
        <meta name="description" content="Shorten and Share, right from your browser, instantly" />
    
    </head>
    <body>
        <div id="container">
            
            <!-- <div id="top">
            </div> <!-- end #top --> -->
            <div id="middle">
                <textarea id="instant_clipboad_copy_space"></textarea>
            </div> <!-- END #middle -->
            <div id="bottom">
                    <div id="escape_worker"></div>
            </div> <!-- end #bottom -->
        
        </div> <!-- end #container -->
        
        <!-- compress and build these?????? -->
        <script type="text/javascript" src="js/bitlyapi-v3.0.js"></script>
        <!-- //*this file does NOT appear in GIT, you will have to manually add the correct credentials* -->
        <script type="text/javascript" src="js/bitly_oauth_credentials.js"></script>
        
        <script type="text/javascript" src="js/bExt/bExt.js"></script>
        <script type="text/javascript" src="js/bExt/bExt.Evt.js"></script>
        <script type="text/javascript" src="js/bExt/bExt.Eventer.js"></script>
        <script type="text/javascript" src="js/bExt/bExt.hovercard.js"></script>
        <script type="text/javascript" src="js/bExt/utilities/utils.js"></script>
        <script type="text/javascript" src="js/bExt/bExt.bg_listeners_chrome.js"></script>
        
        
        <script type="text/javascript" src="js/sqldb-v1.0.js"></script>
        <script type="text/javascript" src="js/libs/md5.js"></script>
        <script type="text/javascript" src="js/libs/bg_common.js"></script>
        <script type="text/javascript" src="js/libs/bg_getset_common.js"></script>
        
        <script type="text/javascript" src="js/libs/common.js"></script>
        <script type="text/javascript" src="js/libs/bitNote.js"></script>
        
        <script type="text/javascript" charset="utf-8">
            // restart...
            var api_success = bExt.init_api();
            if(!api_success) {
                console.log("user is logged out");
                // set logged out
                if( !chrome.browserAction.onClicked.hasListener( bExt.evt_button_listen ) ) {
                    chrome.browserAction.onClicked.addListener( bExt.evt_button_listen );
                }                
            } else {
                // set logged in...
                bExt.trends.init();
                bExt.set_popup();
            }
            bExt.init_db();
            console.log("new structure bExt.Eventer");
            bExt.events=new bExt.Eventer();
            
            // see js/bExt/listeners_chrome.js
            bExt.events.register(null, bExt.bg_listeners_chrome);
            bExt.events.chrome_listen();
        </script>
        
        
        <script type="text/javascript" charset="utf-8">
        
        
        // for use with expand_and_meta
        
        // calls bit.ly, so has to say here for a moment until we clear up dependencies
        // the ISSUE
        // is that user credentials are getting stored POORLY
        // this makes it required to ask the bitly object for information
        // while this makes sense, it's a global object
        // ....
        
        // Start the App controls
        function init_api() {
            // get from local storage?
            // pull this value from a settings file
            if(!bitly_oauth_credentials) {
                console.log("a required file is missing! please add a valid js/bitly_oauth_credentials.js")
                throw "MISSING_CREDENTIALS_FILE";
            }
            var b = bitlyAPI( bitly_oauth_credentials.client_id, bitly_oauth_credentials.client_signature );
            return b;
        }
        function init_db( name ) {
            return sqlDB("bitly_local_db");
        }
        
        function test_metrics() {
            // clicks|country|referrers
            bitly.metrics("clicks", function(jo) {
                // need to send param: days=40, days:2, days:5
                console.log("clicks", jo);
            });
            
            bitly.metrics("countries", function(jo) {
                console.log("country", jo)
            });
            
            bitly.metrics("referrers", function(jo) {
                console.log("referrers", jo)
            });
        }
        
        /////////////////////////////////////////////////////////////
        /// START UP the Chrome Extension Application..
        /*
            Variable Information
                bitly -- the global variable and interface to the bit.ly API
                            Options like, user Auth Key, oAuthToken are stored here
                        
                        Make methods available to api.bitly.com
                
                bit_db -- the global variable for the SQL Lite interface
                
                trends_worker -- a long running worker process that checks
                                    for currently trending USER links
                                    This is a 'short' poll SSL interface
                
                domains_list  -- bit.ly what label domains to check against to avoid unneeded lookups
                                    Resolves issues with incorrectly expanding non bit.ly domains
        
        */
        logger("Initialize bit.ly extension");
        // the bit.ly API connector, db interface and other global variables
        var bitly=init_api(), bit_db=init_db(),
            trends_worker, domains_list,
            auto_expand_urls = true, enhance_twitter_com=true, context_menu_added=false, notify_on_context_menu=false,
            // for google tracking, when that's ready
            _gaq = _gaq || [];
        
        // Initialize Cache Items
        // expire_old_blacklist();
        // trends_worker = new Worker("js/workers/realtime_data.js");
        // trends_worker.onmessage = trends_worker_message_event;
        
        // derive items from cache
        
        
        initialize_data_from_local_cache();
        
        
        
        /*
            Listen for requests from content scripts, popups and other pages etc
                Party Line, everyone is talking
                    Everyone is invited....
        */
          
          


        
        // function browser_action_listener( curr_tab ) {
        //     // if popup is NOT set, this event will be triggered
        //     get_chrome_page("options.html");
        // }        
 
        /*
            Support for external shortens?
            http://code.google.com/chrome/extensions/extension.html
            chrome.extension.onConnectExternal.addListener(function(Port port) {...});
        */
        
        

        //chrome.extension.onRequest.addListener(actions_listeners);
        
        // add skip the popup check
        
        
        /*
            TODO
            // do not implement this!
            
            analytics init
                this is broken on Google's side
                http://code.google.com/chrome/extensions/trunk/tut_analytics.html
        */
        
        // _gaq.push(['_setAccount', 'UA-XXXXXX-X']);
        // _gaq.push(['_trackPageview']);
        //
        // (function() {
        //   var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        //   ga.src = 'https://ssl.google-analytics.com/ga.js';
        //   (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ga);
        // })();
        
        </script>
    
    </body>
</html>

