<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<!-- MIME TYPE Guidlines and references: http://hixie.ch/advocacy/xhtml -->
    <head>
        <title></title>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta name="keywords" content="awesome" />
        <meta name="description" content="" />
        
    </head>
    <body>
        <div id="container">

            <div id="top">

            </div> <!-- end #top -->
            
            <div id="middle">

            </div> <!-- END #middle -->
        
            <div id="bottom">

            </div> <!-- end #bottom -->
            
        </div> <!-- end #container -->
    
        
        <script type="text/javascript" src="js/bitlyapi-v2.0.js"></script>
        <script type="text/javascript" charset="utf-8">
            
            
            function init_api() {
                // get from local storage?
                // use the 
                
                var login = 'chromext',
                    apiKey = 'R_042ce7bde03d756e0448b28b1f2c4aa3',
                    b = BitlyAPI(login, apiKey);
                    
                //b.set_credentials("gregory80", "R_c699d2dfba6ec2343243c607a17e188a")                
                return b;
//              return BitlyAPI("gregory80", "R_c699d2dfba6ec2343243c607a17e188a");                                 
            }
            
            
            
            var bitly = init_api();
            
            
            function test_shorten() {
                bitly.shorten("http://jehiah.cz", function(response) {
                    console.log("woo-hoo a callback", response)
                });                
            }
            
            function test_expand( the_url_or_urls ) {
                bitly.expand("http://gt-co.de/b9jSS9");
                bitly.expand(["http://gt-co.de/9r2DgB", "http://gt-co.de/b9jSS9"])
            }
            
            function test_overload() {
                var many_urls = ["http://bit.ly/aYOnWr", "http://gt-co.de/9r2DgB", "http://gt-co.de/b9jSS9", "http://bit.ly/bn8RFF", "http://bit.ly/dfD4Ya", "http://bit.ly/9lksmy", "http://bit.ly/bHLvTA", "http://bit.ly/bHLA", "http://bit.ly/9ZRrsZ", "http://bit.ly/bMKKxB", "http://bit.ly/bjlNiP", "http://bit.ly/d5Hz9n", "http://bit.ly/9ozQ28", "http://bit.ly/9m6y86", "http://bit.ly/9JdS3p", "http://bit.ly/bmGYxY", "http://bit.ly/bVr7fH", "http://bit.ly/9mBQBV"]
                bitly.expand( many_urls, function(response) {
                    console.log(response, " final overload call, right?");
                } );
            }
            
            function run_tests() {
                bitly.auth("exttestaccount", "whatever", function(response) {
                    console.log("callback for auth is -->", response)
                    
                    
                    test_shorten();
                    //test_expand();  
                    test_overload();                  
                    
                });
                
                

                

            }
            
            run_tests();



            /*
                Connections:
                           chrome.extension.onRequest.addListener(function( request, sender, sendResponse ) {
            */
            
            function actions_listeners( request, sender, sendResponse ) {
                if(!request.action) return;
                var act = request.action;
                switch( act ) {
                    
                    
                    case "shorten":
                        console.log("shorten")
                        bitly.shorten( request.long_url, sendResponse );
                    break;
                    
                    case "expand":
                        // this event triggered by a content script
                        bitly.expand( request.short_url, sendResponse );
                    break;
                    
                    default:
                        // fall throw
                    break;
                    
                    
                }
                console.log("hear a request", request)
                sendResponse({"foo" : "bar"})                
            }
            
            
            chrome.extension.onRequest.addListener(actions_listeners);
            
        </script>
      
    </body>
</html>
