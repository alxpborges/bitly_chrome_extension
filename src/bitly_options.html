<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <title>Account Settings | bit.ly Shorten, Share &amp; Track </title>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta name="keywords" content="" />
        <meta name="description" content="" />
        
        <link rel="stylesheet" href="css/bitly_basic.css" type="text/css" charset="utf-8" />
        <link rel="stylesheet" href="css/bitly_ext_common.css" type="text/css" charset="utf-8" />
        <link rel="stylesheet" href="css/bitly_options.css" type="text/css" charset="utf-8" />
        <!-- 
                    TODO: Deprecated Page
                        Warning, keep this file for a bit as we don't know what's staying and going yet
        
         -->
        <link rel="shortcut icon" type="image/png" href="s/graphics/favicon.ico" />
    
    </head>
    <body>
        <div id="container">
            <!-- Put Content Here -->
            
            <div id="top">
                
                <div id="blueBanner">
                    <ul class="ext_nav_list">
                        <!-- <li><a class="openOptions" href="">Options</a></li> -->
                    </ul>
                
                </div>
                
                <div id="logo">
                    <a href="http://bit.ly/"><img src="s/graphics/bitly_logo.png" alt="" border="0"width="280px" height="47px"  /></a>
                </div>
                <!-- <div id="ext_top_nav">
                    <div id="ext_top_nav_inner">
                    
                    </div>
                    <div class="hr"><hr /></div>
                </div> -->
            
            </div> <!-- end #top -->
            
            <div id="middle">
                    
                    <div id="signOutButtonContainer">
                        <a href="#">Sign Out</a>
                    </div>
                    <h1 id="bitly_options">bit.ly Options</h1>
                     <div id="signinContainer" style="display:none;" class="optionsDataContainer">
                            
                            <div id="signinContainerInner">
                               <form action="#" id="bitly_signin_submit" method="get" accept-charset="utf-8">
                                   
                                   <div id="bitly_authentication_boxes">
                                       <div class="inputContainer">
                                               <label for="username">Username</label>
                                               <input type="text" name="username" placeholder="bit.ly username" value="" id="username" />
                                          </div>
                                          
                                          <div class="inputContainer">
                                              <label for="password">Password</label>
                                              <input type="password" name="password" value="" id="password">
                                          </div>
                                   </div>
                                   
                                   <div id="bento_action">
                                       <input type="submit" class="activeButtons mediumSizeButton" name="submit" value="Sign In" id="some_name">
                                   </div>
                                   
                                   <div class="hr"><hr /></div>
                               
                               </form>
                            
                            </div> <!-- end #ext_bento_inner -->
                            
                            
                            <!-- <div id="ext_bento_options">
                                <div id="ext_bento_options_inner">
                                    <a href="" class="signUpPromoButton mediumSizeButton">Sign Up</a>
                                
                                </div>
                            </div> -->
                        
                        
                        </div>   <!-- end #signinContainer -->
                        
                        
                        <div class="optionsDataContainer">
                            <h2>Shorten Settings</h2>
                            <div class="bentoOptions">
                                <input type="checkbox" checked name="auto_clear_after_share" value="" id="share_text_clear">
                                <label for="share_text_clear">Clear my old message after I share it.</label>
                            </div>
                        </div>
                        
                        <div class="optionsDataContainer">
                            <h2>URL Expansion</h2>
                            <div class="bentoOptions">
                                <input type="checkbox" name="expand_urls" value="" checked id="expand_urls">
                                <label for="expand_urls">Expand all short links on any page I visit.</label>
                            
                            </div>
                        </div>
                        
                        <div id="loginDetailsContainer" class="optionsDataContainer">
                            <h2>API Key</h2>
                            
                            <p>You can provide your API key to third parties instead of giving them your password.  If you think a 3rd party is using your API key inappropriately, you can <a href="http://bit.ly/a/account">reset it</a>.</p>
                            
                            <div class="api_type_selector">
                                
                                
                                <p>You can choose either the bit.ly API or the j.mp API. Both work just the same way, but j.mp is just a little shorter. This change only applies to new shortens.</p>
                                
                                <form id="api_choice_form" action="#" method="get" accept-charset="utf-8">
                                    
                                    <div class="bentoOptions">
                                        
                                        <input type="radio" name="api_choice" checked value="bit.ly" id="jmp">
                                        <label for="jmp">Use bit.ly API</label>
                                    </div>
                                    
                                    <div class="bentoOptions">
                                        <input type="radio" name="api_choice" value="j.mp" id="bitly">
                                        <label for="bitly">Use j.mp API</label>
                                    
                                    </div>
                                
                                
                                </form>
                            </div>
                            <div id="loginDetailsContainerInner">
                            
                            </div>
                            
                        
                        
                        </div>
                    
                    
                    <!-- <div class="optionsDataContainer">
                        <div class="bentoOptions">
                            <input type="checkbox" checked name="" value="" id="">
                            <label for="">Automatically copy to my clipoard</label>
                        </div>
                    </div> -->
                    
                    <div id="debug">
                    
                    </div>
            
            </div> <!-- END #middle -->
            
            <div id="bottom">
            
            </div> <!-- end #bottom -->
        </div> <!-- end #container -->
        
        <script type="text/javascript" src="js/bitly_settings.js" charset="utf-8"></script>
        <script type="text/javascript" src="js/jquery-1.4.2.js"></script>
        <script type="text/javascript" src="js/plugins/jquery.chunk.js"></script>
        <script type="text/javascript" src="js/plugins/jquery.errorMessenger.js"></script>
        <script type="text/javascript" src="js/plugins/jquery.escapeHTML.js"></script>
        <script type="text/javascript" src="js/plugins/jquery.sql.js" charset="utf-8"></script>
        <script type="text/javascript" src="js/plugins/jquery.connector.js"></script>
        <script type="text/javascript" src="js/plugins/jquery.localStorage.js"></script>
        
        <script type="text/javascript" charset="utf-8">
            
            $.connectorSetup({
                host : 'http://' + bitly_settings.host
            });
            
            
            // var port
            //     bitly = {},
            //     STANDARD_HOST = "http://" + bitly_settings.host;
            // bitly.user_data = $.localStorage.get("user_data") || {}
            
            var popup_port;
            
            $(function() {
                // on load
                
                
                var user_data;
                popup_port = chrome.extension.connect({name: "popup"});
                
                popup_port.postMessage({type: "list_accounts"});
                //port.postMessage({'type': 'recent_metrics'})
                popup_port.postMessage({'type': 'user_data'}) ;
                popup_port.postMessage({'type': 'domain'})
                popup_port.onMessage.addListener(function(msg) {
                   console.log(msg.type, msg);
                   if(msg.type === "add_account") {
                       drawAccounts( msg.accounts );
                       return;
                   }
                   
                   if( msg.type === "expand_urls" ) {
                       return;
                   }
                   
                   if( msg.type === "remove_account") {
                       drawAccounts( msg.data.accounts );
                       return;
                   }
                   
                   if(msg.type === "clear_messages" ) {
                       $clear = $('#share_text_clear')
                       $clear[0].checked = msg[ $clear.attr('name') ];
                       //clear_after_share
                   }
                   if(msg.type === "list_accounts") {
                       drawAccounts( msg.data.accounts );
                       return;
                   }
                   if(msg.type === "accounts") {
                       if(msg.data.accounts && msg.data.accounts.length <=0) return;
                       drawAccounts( msg.data.accounts );
                       return;
                   }
                   
                   if(msg.type === "signout_user") {
                       // TODO ?
                       setTimeout(function(){
                           location.reload();
                       }, 100)
                       return;
                   }
                   
                   if(msg.type === "domain") {
                       // look for the correct checked items
                       if(!msg.domain) return;
                       var radios = $('#api_choice_form').find('input[type=radio]')
                       for(var i=0; i<radios.length; i++) {
                           var value = radios[i].getAttribute('value')
                           if(value === msg.domain) radios[i].checked = true;
                           else radios[i].checked=false;
                       }
                       return;
                   }
                   
                   if(msg.type === "user_data") {
                       user_data = msg.user_data;
                       drawUserData( user_data );
                       if(user_data && user_data.login) {
                        // this is currently backwards for testing...
                        $('#signinContainer').css('display', 'none')
                        $('#loginDetailsContainer').css('display', 'block')
                        $('#bitly_options').html(user_data.login + " Account Settings")
                       
                       } else {
                           authenticateUser();
                           $('#signinContainer').css('display', 'block')
                           $('#loginDetailsContainer').css('display', 'none')
                       }
                       return;
                   }
                });
                
                console.log($('#api_choice_form').find('input'))
                $('#api_choice_form').find('input[type=radio]').live('change', function(e) {
                    var $this = $(this);
                    console.log('hear the click...', $this.val())
                    popup_port.postMessage({'type': 'domain', 'domain' : $this.val()})
                
                });
                
                $('#expand_urls').live('click', function(e) {
                    // send an event, yo
                    var $this = $(this);
                    console.log($this)
                    console.log('this doesnt work yet')
                })
                
                $('#signOutButtonContainer a').live('click', function(e){
                    e.preventDefault();
                    /*
                        TODO:
                        delete the user_data....
                        remove the Database entry
                    
                    */
                    console.log('signing out...')
                    popup_port.postMessage({'type': 'signout_user'})
                })
                
                $('#share_text_clear').bind('change', function(e) {
                    
                    console.log("Settings: Manage clearing message success response.")
                    popup_port.postMessage( { 'type' : 'clear_messages', "auto_clear_after_share" : this.checked }  )
                });
            
            }); // end on load event
            
            
            function drawUserData( user_data  ) {
                console.log(user_data, "drawUserData");
                if(!user_data || !user_data.login) return;
                var html = '<div class="" id="bitly_user_data_container">';
                    html += '<div class="bitly_data_container bitly_user_data_item inputContainer">'
                        //html += '<label>API Key</label>'
                        html += '<input type="text" name="apiKey" class="largeSizeInput largeSizeInput_apiKey" value="'+ $.escapeHTML(user_data.apiKey) +'" />'
                    html += '</div>'
                
                html += '</div>'
                var $l = $('#loginDetailsContainerInner')
                $(html).appendTo( $l )
            
            }
            
            function drawAccounts( accounts  ) {
                $('.linkedAccountsList').remove();
                 var html = "<div class='linkedAccountsList'>";
                 // TODO: somehow get data about what accounts are linked to this bit.ly account
                    html += '</div>'
                 $(html).prependTo('.addLinkedAccountBlock');
            }
            
            function authenticateUser() {
                var port = chrome.extension.connect({name: "auth"});
                    
                    port.onMessage.addListener(function(msg) {
                      // this person logged in... I need to load a different popup now... or force this to close
                      console.log('the message', msg, window, location, document)
                      if (msg.error ) {
                          var error='';
                          for (var i=0;i<msg.error.length; i++) {
                              error += $.escapeHTML(msg.error[i]) + '<br>';
                          }
                          $('<div class="error"></div>').html(error).prependTo($('#bitly_signin_submit'));
                      }
                      if( msg.success ) {
                          //chrome.browserAction.setPopup({ "popup" : "bitly_bento.html"})
                         //location.href=chrome.extension.getURL("bitly_bento.html");
                         // well this seems work
                         // TOOD
                         // this doesn't really work
                         
                         // find a way to do this... now have to close and open container
                         
                         //location.href=chrome.extension.getURL("bitly_bento.html");
                         
                         //console.log(location.href)
                         setTimeout(function(){
                             location.reload();
                         }, 100)
                          
                          //window.location=chrome.extension.getURL("bitly_bento.html");
                      }
                   });
                  
                  $('#bitly_signin_submit').bind('submit', function(e) {
                      
                      e.preventDefault();
                      console.log('submit the signin form')
                      var $this = $(this), $elem, params = {},
                          fields = $this.find('.inputContainer input');
                      
                      $this.find('.error').remove();
                      
                      for(var i=0; i<fields.length; i++) {
                          // i'm doing this b/c each is supposed to be really slow....
                          $elem = $(fields[i]);
                          // console.log('$elem', $elem)
                          params[ $elem.attr('name') ] = $elem.val();
                          // login, password?
                      }
                      
                      if(params.username === '' || params.password === '' ) {
                          console.log('error...')
                          $('<div class="error"></div>').html("Username or password missing").prependTo($this)
                          // changet the ui
                          return;
                      }
                      $this.find('input[type=submit]').addClass('disabledState').removeClass('activeButtons')
                      console.log('posting message', params)
                      port.postMessage( params )
                  })
            }
        </script>
    </body>
</html>
