<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    
    <head>
        <title>bit.ly | Shorten, Share &amp; Track your links</title>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <link rel="stylesheet" href="css/basic.css" type="text/css" charset="utf-8" />
        <link rel="stylesheet" href="css/popup.css" type="text/css" charset="utf-8" />
    </head>
    <body class="popup_body">
        <div id="container">
            
            <div id="top">
            
            </div> <!-- end #top -->
            
            <div id="middle">
                
                <form action="#" id="bitly_bento_submit" method="get" accept-charset="utf-8">
                      
                      <div class="bentoShareBoxContainer">
                          <textarea id="bento_share" name="bento_share"></textarea>
                          <div id="loading_short_url">
                              <img src="s/graphics/loader_58_58.gif" border="0" alt="0" />
                          </div>
                      </div>
                      <div id="sharing">
                          <div id="sharing_accounts_display"></div>
                          <div id="share_controls" style="display:none;">
                            
                            <div id="sharing_buttons_box">
                            <input class="activeButtons mediumSizeButton" type="submit" name="share_button" value="Share" id="share_button">
                            </div>
                            <div id="share_loading_graphic">
                                <img src="s/graphics/loader_share_30_30.gif" height="30" width="30" border="0" alt="" />
                            </div>
                          
                          </div>
                          <div id="message_box" style="display:none;"></div>
                          <div class="hr"><hr /></div>
                      </div>
                
                </form>


                
                
                <div class="bitly_shorten_box_meta_links">
                    <a class="options_page" id="options_page" href="options.html">options</a>
                
                </div>
            
            </div> <!-- END #middle -->
            
            <div id="bottom">
            
            </div> <!-- end #bottom -->
        
        </div> <!-- end #container -->
        
        
        
        <script type="text/javascript" charset="utf-8">
            
            // get the current document location
            
            function actions_listeners( request, sender, sendResponse) {
                if(!request.action || request.action !== "page_selection") return;
                txtarea.innerText = (txtarea.value + (request.selection || ""));
            }
            
            function shorten_complete_callback( jo ) {
                _id("loading_short_url").style.display="none";
                var message = txtarea.value, sUrl = jo && jo.url || "";
                if( message === "")  { message = current_title + " " + sUrl; }
                else { message = message + " " + sUrl; }
                txtarea.innerText = message;
            }
            function _id( name ) {
                return document.getElementById( name )
            }
            function share_callback(jo) {
                console.log(jo, "share");
                if(jo.status_code === 403 ) {
                    var share_message = "Error, not signed in <a class='open_options_page' href='#'>Sign In</a> now"
                    display_share_response_message(share_message);
                    return;                    
                } else if( jo.error ) {
                    bg.logger("Error during share" + JSON.stringify(jo) );
                    var share_message = "Error, during share";
                    display_share_response_message(share_message);
                    return;
                } else if(jo.share.length <=0) {
                    return;
                }

                
                var i=0, accounts=jo && jo.share, 
                    account, success_messages = 0, share_message;
                
                for( ; account=accounts[i]; i++) {
                    if(account.error) {
                        
                    } else {
                        success_messages +=1
                    }
                }
                
                if(success_messages>0) {
                    share_message = "Success. Shared your message on " + success_messages;
                    share_message += " of " + accounts.length + " accounts";
                } else {
                    share_message = "Oops, something went wrong. Didn't share to any accounts."
                }
                display_share_response_message( share_message )
            }
            
            function display_share_response_message( share_message ) {
                var message = _id("message_box");
                txtarea.innerHTML = "";                
                message.innerHTML = share_message;
                message.style.display="block";
                
                _id("share_loading_graphic").style.display="none";
                _id("sharing_buttons_box").style.display="block";    
                setTimeout(close_message_box, 4000);                            
            }
            function close_message_box() {
                var message = _id("message_box");
                message.style.display="none";
                txtarea.innerHTML = stash_text;
            }
            function list_accounts_callback(jo) {
                //console.log(jo)
                var i=0, account, accounts = jo && jo.share_accounts, html = "",
                    status, images=[], img;
                
                active_account_list = [];
                if(accounts.length > 0 ) {
                    html += '<span class="share_account_header">Active:</span>'
                    html += '<ul id="share_accounts">'
                    for( ; account=accounts[i]; i++) {
                        status = (account.active) ? "on" : "off";
                        if(account.active){ active_account_list.push( account ); }
                        
                        html += '<li>'
                            html += '<img class="account_icon" id="'+ account.account_id + '"';
                            html += ' title="' + (account.account_name || account.account_login) + '" '
                            html += ' src="s/graphics/'+account.account_type+'-'+status+'.png" border="0" alt="" />'
                        html += '</li>'
                    }
                    html += '</ul>';
                    html += '<div class="hr"><hr /></div>'
                    _id("share_controls").style.display="block";
                }
                
                
                _id("sharing_accounts_display").innerHTML = html;            
            }
            
            // end definitions
            
            
            var txtarea = _id("bento_share"), share_form = _id("bitly_bento_submit"),
                current_title = "", stash_text = "",
                active_account_list = [], b = _id("options_page"),
                bg = chrome.extension.getBackgroundPage(),
                message_box_elem = _id("message_box");
            
            // Shorten the current tab
            chrome.tabs.getSelected(null, function( curr_tab) {
               
               console.log( curr_tab );
               
               var message = {
                   'action' : 'shorten_and_select',
                   'long_url' : curr_tab.url,
                   'tab_id' : curr_tab.id,
                   'title' : curr_tab.title
               }
               current_title = curr_tab.title
               chrome.extension.sendRequest( message, shorten_complete_callback );
               chrome.extension.sendRequest( {'action' : 'share_accounts' }, list_accounts_callback )
                
            
            });
            
            message_box_elem.addEventListener('click', function(e) {
                
                if(e.target.className === "open_options_page") {
                    e.preventDefault();
                    bg.get_chrome_page("options.html");
                }
            })
            
            share_form.addEventListener('submit', function(e) {
                e.preventDefault();
                var txt = txtarea.value, params = {'action' : 'share' };
                if(txt !== "" && active_account_list.length > 0 ) {
                    params.share_text = stash_text = txt;
                    
                    _id("share_loading_graphic").style.display="block";
                    _id("sharing_buttons_box").style.display="none";
                    
                    chrome.extension.sendRequest( params, share_callback );
                } else {
                    console.log("nothing to share, error the UI")
                    _id("share_loading_graphic").style.display="none";
                    _id("sharing_buttons_box").style.display="block";
                }
                console.log(txtarea.value)
            });
            
            _id("sharing_accounts_display").addEventListener('click', function(e) {
                if(e.target.nodeName.toLowerCase() === "img") {
                    var img = e.target, src = img.src,
                        status = (src.indexOf("on.png") < 0 ),
                        params = {'action' : 'activate_account'};
                    params.account_id = img.id;
                    params.active = status
                    
                    chrome.extension.sendRequest( params, list_accounts_callback )
                }
            });
            
            
            b.addEventListener('click', function(e) {
                
                e.preventDefault();
                bg.get_chrome_page("options.html");
            
            });
            

/*
    // images = _id("share_accounts").getElementsByTagName("img")
    // for(var i=0, img; img=images[i]; i++) {
    //     console.log(i, "second loop")
    // }
*/
            
            chrome.extension.onRequest.addListener(actions_listeners);
        
        </script>

      
    
    </body>
</html>
