<html>
<head></head>
<body>
    <div id="brain_container">
        <h1 id="hello_bitly">Hello, This is the  bit.ly brain</h1>
        <p>I can do several things well, a few things badly and most things not at all. What I can do is:</p>
        <ul>
            <li>Shorten a URL</li>
            <li>Tweet / share on accounts you have authorized on bit.ly website.</li>
            <li>Take a screenshot of the visible tab area, upload it to tweetphoto.com and give me back a URL (not shortened by bit.ly)</li>
            <li>Grab images off a page and upload to tweetphoto.com and return a url</li>
            <li>Get metrics data for the page you are looking at</li>
            <li>Compare, graphically several different pages via a search interface</li>
        </ul>
        
        <div id="debugger">
        
        </div>
    </div>
    
    <script type="text/javascript" src="js/bitly_settings.js" charset="utf-8"></script>
    <script type="text/javascript" src="js/jquery-1.4.2.js" charset="utf-8"></script>
    <script type="text/javascript" src="js/plugins/jquery.sql.js" charset="utf-8"></script>
    <script type="text/javascript" src="js/plugins/jquery.chunk.js" charset="utf-8"></script>
    <script type="text/javascript" src="js/plugins/jquery.connector.js"></script>
    <script type="text/javascript" src="js/plugins/jquery.localStorage.js"></script>
    <script type="text/javascript" src="js/plugins/jquery.socialLinkedAccounts.js" charset="utf-8"></script>
    <script type="text/javascript" src="js/plugins/jquery.escapeHTML.js"></script>
    <script type="text/javascript" src="js/plugins/jquery.validateUrl.js"></script>
    <script type="text/javascript" src="js/listeners/auth_query_listener.js"></script>
    
    <!-- TODO: INSERT COMPRESSED FILE ON PACKING AND RELEASE -->

<script type="text/javascript" charset="utf-8">
    
    $.connectorSetup({
        host : 'http://' + bitly_settings.host
    });
    $.ajaxSetup({
        cache : false,
        traditional : true,
        timeout : 12000
    });
    
    $.sql.createTable( bitly_settings.users_table, bitly_settings.schemas.users, initializePage, initializePage);
    $.sql.createTable( bitly_settings.bitly_data_table, bitly_settings.schemas.bitly_data, initializePage_bitly_data, initializePage_bitly_data);
    
    /*
        Developer notes:
            Be careful when migrating data structures. Local storage will require specific schema planning
            
            Note: currently the value for window.localStorage space is unknown.
                In the current structure, shortens are stored.
                It would be possible to exceed 100 in length for any of these arrays in common use.
                This would ammass a considerable data very quickly.
    
    */
    // call the same callback for success AND error
    // do this until I can see if a table exists easily... maybe a read???????

    
    
    
    /*
        Architecture Flow
            
            1. create database
            2. Open several port listeners
                1. popup
                2. metrics
                3. linked_accounts
                --TO BE ADDED--
                4. Share
                5. Authenticate
            -- Scenarios:
                Shorten Request
                    1. Look up hash in local DB
                    2. On failure, call server
                        A. Get shorten request back, process and add fields
                            Activate workers:
                            a1. Take picture of this page - (figure out how to DOWN SIZE the raw string in browser)
                            a2. re-sample via canvas tag and export smaller value...
                            C. write to database
                            D. Store image string (just one)
                    3. Send data back to requestor
                
                Upload Screen Capture
                    1. Take a fresh screen capture
                    2. upload via brain (persistent) to tweetphoto
                    3. get response, save information into share text? _some other field_
                    4. write to database??
                    5. send back to requestor
             
             3. open onRequest listener for single events
           
           
           Local Storage:
                    App settings,
                    user auth credentials,
                    oauth tokens
    
    */

    console.log("Getting bitly_data from localStorage")
    var worker, current_tab, active_tabs, total_metrics_worker,
        bitly_data = $.localStorage.get(bitly_settings.local_key),
        bitly = {},
        STANDARD_HOST = "http://" + bitly_settings.host;
    bitly.user_data = $.localStorage.get("user_data") || {}
    console.log('getting from memory:', bitly_data)
    
    if(!bitly_data) {
        bitly_data = {
            type : "master_data_file",
            pages : [],
            accounts : [],
            screens : [],
            auto_clear_after_share : true,
            expand_urls : true,
            domain : "bit.ly",
        }, current_tab, active_tabs;
    
    }

    
    if(  !chrome.extension.onConnect.hasListener( popup_connection_listener ) ) {
        chrome.extension.onConnect.addListener(popup_connection_listener);
    }
    
    if(  !chrome.extension.onConnect.hasListener( urlexpander_connection_listener ) ) {
        chrome.extension.onConnect.addListener(urlexpander_connection_listener);
    }
    
    if(  !chrome.extension.onConnect.hasListener( sharing_actions_listener ) ) {
        chrome.extension.onConnect.addListener(sharing_actions_listener);
    }
    
    /*
        listeners/auth_query_listener.js
    */
    if(  !chrome.extension.onConnect.hasListener( auth_query_listener ) ) {
        chrome.extension.onConnect.addListener( auth_query_listener );
    }
    

// fake it!
    bitly.user_data.login = "gregory80"
    bitly.user_data.apiKey = "R_c699d2dfba6ec2343243c607a17e188a"
    $.localStorage.set('user_data', bitly.user_data);
    $.localStorage.set(bitly_settings.local_key, bitly_data)    
    
    if(bitly.user_data && bitly.user_data.login !== undefined ) {
        /*
            logged in users get differet treatment
                
                Ideas:
                    This could be switched to a metrics popup (no shorten) via an options setting
        */
        console.log(bitly.user_data.login, "login")
        if(bitly.user_data.login ) chrome.browserAction.setPopup({ "popup" : "bitly_bento.html"});
    }
    
    
    chrome.browserAction.onClicked.addListener(function(event) {
        console.log('DUDE I totally heard the click even.. no way', event)
    })
    
    /*
        HTML5 JS Workers
            1. Resize thumbnails to be smaller b/c data storage is a problem
    
    */
    // worker = new Worker("js/workers/screen_resizer.js");
    // // Watch for messages from the worker
    // worker.onmessage = function(e){
    //     console.log('worker message',e.data)
    //   // The message from the client:
    //   if( e.data.type === "resize" ) {
    //
    //       console.log("Worker: Type screen_resizer: image data string is now", e.data.screen_grab.length)
    //       add_raw_string_screen_captures( e.data.long_url, e.data.screen_grab );
    //
    //       $.localStorage.set( bitly_settings.local_key , bitly_data );
    //       store_bitly_data_to_db();
    //   }
    //
    // };
    
    // total_metrics_worker = new Worker("js/workers/total_metrics.js");
    // Watch for messages from the worker

        
    
    /* end workers  */
    
    
    /*
        Listen for single requests for data
            http://code.google.com/chrome/extensions/extension.html
        
    
    */
    chrome.extension.onRequest.addListener(function(message,sender,sendResponse) {
        console.log(message,sender, "request to add screen grab for this account")
        // if($.inArray( message.screen_grab, bitly_data.screens )) {
        //     // i probably uploaded this... do I have the response data somewhere?
        // }
        
        /*
            Listen for screen captures.
                This is the actual request to upload a photo to tweetphoto.com
                
                I am storing
        */
        
        // if(message.type === "screen_grab") {
        //     console.log('saving screen grab', message)
        //     var screen_grab = message.screen_grab;
        //     chrome.tabs.getSelected(null, function(curr_tab) {
        //         connect_upload_screen_captures( screen_grab, function(jo) {
        //             console.log('trying to send the screen grab data response', jo)
        //             for(var i=0; i<jo.photos.length; i++) {
        //                 add_screen_grab_webservice_response( curr_tab.url, jo.photos[i] )
        //             }
        //
        //             $.localStorage.set( bitly_settings.local_key , bitly_data );
        //             sendResponse(jo);
        //         })
        //
        //     });
        //
        // }
    
    });
        

        
        
        /*
            Message Types:
                
                shorten_tab : a basic shortening of the current tab URL
                accounts : get sharing accounts for this user.
                update_text_area : save the state of the text area to be displayed after popup loses state
        
        */
    
    function initializePage() {
        // this is for the database
        console.log("DB", arguments)
        
        // if user not logged in, try and get from the DB
        if(!bitly.user_data || !bitly.user_data.login || !bitly.user_data.apiKey) {
            $.sql.select(bitly_settings.users_table, ["*"], "",  function( transcation, result  ) {
                console.log('arguements for query to get from db', arguments)
                console.log(transcation)
                console.log(result)
                
                for (var i = 0, item = null; i < result.rows.length; i++) {
                  item = result.rows.item(i);
                  bitly.user_data.login = item['login']
                  bitly.user_data.apiKey = item['apiKey'];
                  bitly_data.accounts = JSON.parse( item['accounts'] || {} ).accounts || [];
                    for(k in item) {
                        console.log(k, item, item[k], "this is what I found!")
                    }
                }
                
                console.log('bitly_data', bitly_data, 'user_data', bitly.user_data)
                $.localStorage.set('user_data', bitly.user_data);
                $.localStorage.set(bitly_settings.local_key, bitly_data)
                console.log('Setting into memory DB values!')
                
                console.log(result, result.rows, "looked it up in db")
                if(result && result.rows.length>0) chrome.browserAction.setPopup({ "popup" : "bitly_bento.html"});
            })
            
            // really, really make sure the right popup is set...
            // hmmm
        
        }
    }
    
    function initializePage_bitly_data(tx, result) {
        console.log(tx, result)
        function handle_response(tx,result) {
            console.log(result)
            if(result.rows.length <= 0 ) {
                // okay... I can try and save stuff now... first insert sorta thing
                var sql = "INSERT INTO "+ bitly_settings.bitly_data_table +" (id,bitly_data) VALUES(?,?)";
                console.log(sql, "sql for insert")
                var args = [ bitly_settings.local_key, JSON.stringify( bitly_data ) ]
                $.sql.sqlRaw( sql, args, function(jo) {
                    console.log(jo,arguments,"saving bitly data for first time info")
                })
            
            } else {
                // now I know to do updates....
            }
        }
        $.sql.select(bitly_settings.bitly_data_table, ["*"], "",  handle_response, handle_response);
    }
    
    /*
        bad candiate for remove to different file...
        directly touches bitly_data.pages
        
        need to stop doing that...
    */
    function sharing_actions_listener(port) {
        var current_port=port;
        if(current_port.name !== "popup") {
            console.log('Bailing on sharing_actions_listener, port name is ', current_port.name)
            return;
        }
        
        current_port.onMessage.addListener(function(msg) {
            var types = ["add_account", "clear_messages", "list_accounts", "remove_account", "remove_account", "sharing", "enabled"]
            
            if(types.indexOf(msg.type) == -1) {
                console.log("bail, not sharing", msg.type)
                return;
            }
            
            if(msg.type === "add_account") {
                console.log("trying to add account", msg)
                // connector_sharing(msg, function(jo) {
                //     console.log(jo, "add account connector", msg.type)
                //     //set_linked_accounts(jo.accounts)
                //     bitly_data.accounts = jo.accounts;
                //      _save_linked_accounts();
                //     // hmmmmm
                //     current_port.postMessage( {'accounts' : bitly_data.accounts, 'type' :  msg.type });
                // });
                
                return;
            }
            
            if(msg.type === "clear_messages") {
                console.log('received')
                bitly_data.auto_clear_after_share = msg.auto_clear_after_share;
                
                current_port.postMessage({ 'type' : msg.type,
                                'auto_clear_after_share' : bitly_data.auto_clear_after_share })
                return;
            }
            
            if(msg.type === "list_accounts") {
                console.log("brain hears: ", msg.type)
                //var accounts = get_existing_linked_accounts();
                // console.log('list account here, msg', msg)
                // connector_sharing(msg, function(jo) {
                //     console.log('list accounts', jo)
                //     set_linked_accounts(jo.accounts)
                //     $.localStorage.set(bitly_settings.local_key, bitly_data );
                //     current_port.postMessage( {'data' : jo, 'type' :  msg.type });
                // })
                
                return;
            }
            
            if(msg.type === "remove_account") {
                // connector_sharing(msg, function(jo) {
                //     console.log('removed the account?', jo)
                //     set_linked_accounts(jo.accounts)
                //     //remove_linked_account(jo.accounts);
                //     // $.localStorage.set(bitly_settings.local_key, bitly_data );
                //     current_port.postMessage( {'data' : jo, 'type' :  msg.type });
                //
                // })
                
                return;
            }
            
            if(msg.type === "enabled") {
                // var params = msg;
                // connector_sharing(params, function(jo) {
                //    console.log(jo, "enabled")
                // });
                return;
            }
            
            if(msg.type !== "sharing") return;
            
            
            
            console.log("sharing this message: ",msg.share_text)
            var params = msg;
            connector_sharing(params, function(jo) {
                console.log('sharing response', jo)
                
                for(var k=0; k<jo.length; k++) {
                    // this is potentially bad...
                    if(jo[k].error && jo[k].error !== "") jo.splice(k,1)
                }
                
                // what is this doing?
                if(msg.share_text) {
                    for(var i=0; i<bitly_data.pages.length; i++) {
                        var pg = bitly_data.pages[i];
                        if( pg.hash === msg.page_hash ) {
                            // okay found this thing, now add it?
                            pg.share_text = msg.share_text;
                            if(pg && pg.shares) {
                                pg.shares = pg.shares.concat( jo )
                            } else {
                                pg.shares = [];
                                pg.shares = pg.shares.concat( jo )
                            }
                        
                        }
                    }
                }

                
                $.localStorage.set(bitly_settings.local_key, bitly_data );
                current_port.postMessage( {'data' : jo, 'type' :  msg.type,
                                            'auto_clear_after_share' : bitly_data.auto_clear_after_share });
            })

            

        
        });
    
    }
    
    
    function urlexpander_connection_listener( port ) {
        if(port.name !== "url_expander") return;
        var current_port=port;
        console.log("I like to expand urls!")
        
        if(!bitly_data.expand_urls) {
            console.log("URL expansion is disabled")
            return;
        }
        
        current_port.onMessage.addListener(function(msg) {
            console.log('HELLO, I am from the PAGE! I am doing doing... send me back stuff')
            
            if(!bitly.user_data.login) {
                console.log("your logged out hommy")
                return;
            }
            
            
            if(msg.short_links.length <= 0) return;
            
            var chunks = $.chunk(msg.short_links, 15),
                params = {}, i=0, data=[];
            //params.shortUrl = msg.short_links
            params.login = bitly.user_data.login;
            params.apiKey = bitly.user_data.apiKey;
            // mget this expand
            for(var j=0; j<chunks.length; j++) {
                params.shortUrl = chunks[j];
                $.connector("/v3/expand", params, function(jo) {
                    i+=1;
                    console.log("expand reponse = ", jo)
                    if(jo && jo.status_code === 200 && jo.data.expand.length > 0 ) {
                        data = data.concat( jo.data.expand )
                    }
                    if(i === chunks.length) current_port.postMessage({ "expands" : data } )
                }, function(){
                    console.log('error');
                })
            }
        });
    
    }
    
    function popup_connection_listener( port ) {
        var current_port=port;
        if(current_port.name !== "popup") {
            console.log("Bailing! The port name is: ", current_port.name)
            return;
        } else {
            console.log('Remote connection for port name ', current_port.name, current_port)
        }

        
        current_port.onMessage.addListener(function( message ){
            
            // recent_metrics,
            var types = ["signout_user", "domain", "user_data", "shorten_image", "shorten_tab", "shorten_request", "expand_urls"]
            
            if(types.indexOf(message.type) == -1) return;
            
            if(!message.type) {
                console.log('error: no type specificed', message)
                current_port.postMessage({'error' : 'no type specificed'})
                return;
            }
            console.log(message.type, message);
            
            var message_data = {}
            
            
            if(message.type === "signout_user") {
                console.log(message.type, " is the action")
                bitly.user_data={};
                // delete from DB here
                $.localStorage.set('user_data', bitly.user_data);
                chrome.browserAction.setPopup({ "popup" : "bitly_signin.html"});
                $.sql.deleteFrom( bitly_settings.users_table, function(tx,result) {
                    console.log('tx,result success', tx,result)
                }, function(tx,result) {
                    console.log('tx,result', tx,result)
                });
                console.log('word')
                current_port.postMessage({'user_data' : bitly.user_data, type : message.type})
                
                
                return;
            }
            
            
            if(message.type === "expand_urls") {
                console.log("change the value for expand urls...")
                
                return;
            }
            
            if(message.type === "domain") {
                // save the preffered domain (ie: bit.ly or j.mp)
                if(message.domain) {
                    bitly_data.domain = message.domain;
                    $.localStorage.set(bitly_settings.local_key, bitly_data )
                }
                current_port.postMessage( {'domain': bitly_data.domain, 'type' : message.type})
                return;
            }
            
            if(message.type === "user_data") {
                // echo back user data
                current_port.postMessage( {'user_data': bitly.user_data, 'type' : message.type})
                return;
            }
            
            // if(message.type === "recent_metrics") {
            //     console.log(message.type, "find metrics for hashes")
            //
            //     total_metrics_worker.onmessage = function(e){
            //         if(!e.data) {
            //             current_port.postMessage( { 'type' : message.type})
            //             return;
            //         }
            //         console.log(e, "response for metrics...")
            //         // for(var i=0; i< e.data.clicks.length; i++) {
            //         //     console.log(e.data.clicks[i], "click data")
            //         // }
            //         current_port.postMessage( {'click_data': e.data , 'type' : message.type})
            //         console.log(e.data)
            //         // send response back for display...
            //
            //     }
            //
            //     get_total_clicks_for_recent_shortens();
            //
            //     return;
            // }
            
            
            // okay... I have a message
            // if(message.type === "shorten_image") {
            //     console.log('type', message.type)
            //
            //     var existing_page_image_data = find_page_image_by_hash_and_url( message.data.page_hash, message.data.url )
            //     if(existing_page_image_data) {
            //         current_port.postMessage( {'data': existing_page_image_data, 'type' : message.type})
            //         return;
            //     }
            //
            //
            //     connect_to_shorten(  message.data.url, function(jo) {
            //         console.log('after shorten call', jo);
            //         //message.data.page_hash
            //         //look it up...
            //         add_page_images_by_hash( message.data.page_hash, jo )
            //         $.localStorage.set( bitly_settings.local_key , bitly_data );
            //         current_port.postMessage( {'data': jo, 'type' : message.type})
            //     });
            //
            //     return;
            // }
            
            console.log('message.type ==', message.type)
            if(message.type === "shorten_tab" || message.type === "shorten_request") {
                /*
                    Get the current tab url,
                        if this is a 'requested' url from the text field, handle that
                        get the current tab url
                        
                        shorten and respond
                        
                        -- get it from memory if it exists already... be kind rewind
                */
                
                chrome.tabs.getSelected(null, function(curr_tab) {
                    console.log('check the tab', curr_tab)
                    current_tab = curr_tab;
                    var request_long_url = message.data && message.data.long_url || current_tab.url;
                    var message_data = get_exiting_shorten_data( request_long_url )
                    
                    if(!message_data) {
                        // actually shorten this... never seen it before...
                        connect_to_shorten(  request_long_url, function(jo) {
                            console.log(jo, 'shorten api call complete');
                            if(!jo || jo.status_code !== 200)  {
                                console.log(jo, '/v3/shorten call failed');
                                message_data = {
                                    'share_text' : current_tab.title,
                                    'url' : request_long_url
                                };
                                current_port.postMessage( {'data': message_data, 'error' : jo, type : message.type } );
                                return;
                            }
                            
                            message_data = jo.data;
                            message_data.share_text = current_tab.title;
                            // if( message.type !== "shorten_request" ) {
                            //     message_data.share_text = current_tab.title;
                            //     // message_data.favicon = current_tab.favIconUrl;
                            //     // if(message_data.uploaded_screen_captures) {
                            //     //     var scrn_grb = message_data.uploaded_screen_captures[0];
                            //     //     message_data.share_text += " " + scrn_grb.MediaUrl
                            //     // }
                            // } else {
                            //     message_data.share_text = current_tab.title;
                            // }
                            
                            if(message_data && message_data.hash) set_tab( message_data );
                            // TODO: it isn't clear what actually ends up in message_data
                            current_port.postMessage( {'data': message_data, 'type' : message.type});
                            
                            // chrome.tabs.captureVisibleTab(null, function( image_data ){
                            //     //add_raw_string_screen_captures( request_long_url, image_data );
                            //     worker.postMessage({'type' : 'resize', 'screen_grab' : image_data, 'long_url' : message_data.long_url });
                            // });
                            
                        
                        } );
                        
                        
                        // todo.. there is an error handler availavble. just not using it.
                    } else {
                        console.log('get ' + message.type +' from in memory cache!')
                        console.log('TODO: put in local storage..')
                        // if(message_data.uploaded_screen_captures) {
                        //     var scrn_grb = message_data.uploaded_screen_captures[0];
                        //     if( message_data.share_text.indexOf( scrn_grb.MediaUrl ) <= -1 ) {
                        //         message_data.share_text += " " + scrn_grb.MediaUrl
                        //     }
                        //
                        // }
                        
                        // if(!message_data.screen_captures || message_data.screen_captures.length <=0) {
                        //     chrome.tabs.captureVisibleTab(null, function( image_data ){
                        //         console.log('retry and get screen shot')
                        //         worker.postMessage({'type' : 'resize',
                        //                             'screen_grab' : image_data,
                        //                             'long_url' : message_data.long_url });
                        //     });
                        //
                        // }
                        
                        current_port.postMessage( {'data': message_data, 'type' : message.type})
                    }
                    
                    //chrome.experimental.clipboard.executeCopy()
                
                });
                
                // if I haven't seen this tab before.. shorten it..
                // if I have, pull back what I have
            
            }
       
       });
    }
    
    
    /*  METRICS  */
    
    function metrics_data_loader( curr_tab_id, data, port) {
        
        // yeah do some error handling...
        
        var metrcs_internval = setInterval(function() {
            console.log(port)
            connect_get_hashes(data.hash, function(jo){
                // open a port now
                port.postMessage(jo)
            
            }, function(){})
        
        }, 15000 )
        
        active_tabs.push( { 'tab_id' : curr_tab_id,
                              'port' : port,
                              'user_hash' : data.hash, 'url' : data.long_url,
                              'metrcs_internval' : metrcs_internval  } )
    
    }
    
    function find_page_image_by_hash_and_url( page_hash, image_url ) {
        console.log("running: find_page_image_by_hash_and_url")
        for(var i=0; i<bitly_data.pages.length; i++) {
            var pi = bitly_data.pages[i].page_images;
            if( bitly_data.pages[i].hash === page_hash ) {
                
                if( pi && pi.length > 0) {
                    for(var j=0; j<pi.length; j++) {
                        
                        if( pi[j].long_url === image_url) {
                            //current_port.postMessage( {'data': pi[j], 'type' : message.type})
                            console.log("Found page image in memory", pi[j] )
                            return pi[j];
                        }
                    }
                }
            
            }
        
        }
        
        return null;
    
    }
    
    
    function get_exiting_shorten_data( url ) {
        var message;
        console.log(bitly_data, "bitly data")
        for(var i=0; i<bitly_data.pages.length; i++) {
            if(bitly_data.pages[i].long_url === url ) {
                message = bitly_data.pages[i];
                console.log('found in existing shorten history', message, url);
            }
        }
        return message;
    }
    
    // function add_screen_grab_webservice_response( tab_url, screen_data ) {
    //     // var page = get_exiting_shorten_data( tab_url );
    //     // if(!page) return;
    //     for(var i=0; i<bitly_data.pages.length; i++) {
    //
    //         if(bitly_data.pages[i].long_url === tab_url ) {
    //             message = bitly_data.pages[i];
    //             if(message.uploaded_screen_captures) {
    //                 // check to see if I have this
    //                 if($.inArray( screen_data, message.uploaded_screen_captures ) <= -1) {
    //                     // didn't find it
    //                     message.uploaded_screen_captures.push( screen_data )
    //                 }
    //             } else {
    //                 message.uploaded_screen_captures = [];
    //                 message.uploaded_screen_captures.push( screen_data )
    //             }
    //         }
    //
    //     }
    //
    // }
    
    
    function add_page_images_by_hash( hash_key, jo ) {
        var message, i=0;
        for(; i<bitly_data.pages.length; i++) {
            message = bitly_data.pages[i];
            if(message.hash === hash_key ) {
                if(message.page_images) {
                    // todo, depue this here...
                    message.page_images.push(jo)
                
                } else {
                    message.page_images = []
                    message.page_images.push(jo)
                }
            }
        
        }
    }
    
    function add_raw_string_screen_captures( tab_url, base64_screen_grab ) {
        for(var i=0; i<bitly_data.pages.length; i++) {
            
            // this contains meta data about the page, in this case the raw base 64 string to give to img src
            if(bitly_data.pages[i].long_url === tab_url ) {
                message = bitly_data.pages[i];
                message.ts = (new Date).getTime();
                if(message.screen_captures) {
                    
                    if($.inArray( base64_screen_grab, message.screen_captures ) <= -1) {
                        message.screen_captures.push(base64_screen_grab)
                    }
                
                } else {
                    
                    message.screen_captures = [];
                    message.screen_captures.push( base64_screen_grab )
                }
            
            }
        }
    }
    
    
    function remove_history_page( offset, page_num ) {
        
        bitly_data.pages.reverse();
        var removed_item = bitly_data.pages.splice((offset+page_num),1);
        console.log(bitly_data.pages)
        if(bitly_data.deleted_pages) {
            bitly_data.deleted_pages.push(removed_item)
        } else {
            bitly_data.deleted_pages = [removed_item]
        }
        
        bitly_data.pages.reverse();
        $.localStorage.set( bitly_settings.local_key , bitly_data );
    
    }
    
    function get_chrome_page( page_name ) {
        var url =  chrome.extension.getURL(page_name),
             createTab=true, params = { 'selected' : true, 'url' : url };
        chrome.tabs.getAllInWindow(null, function(tab_array) {
           
           for(var i=0; i<tab_array.length; i++) {
               
               if( tab_array[i].url === url ) {
                   createTab=false;
                   chrome.tabs.update( tab_array[i].id, params);
                   break;
               }
           }
            
            if(createTab) { chrome.tabs.create( { 'url' : chrome.extension.getURL(page_name) }) }
        });
    }

    
    function store_bitly_data_to_db() {
        
        var sql = "UPDATE "+ bitly_settings.bitly_data_table +" (id, bitly_data) VALUES(?, ?) WHERE id=" + bitly_settings.local_key;
        console.log(sql, "sql for update")
        var args = [ bitly_settings.local_key, JSON.stringify( bitly_data ) ]
        $.sql.sqlRaw( sql, args, function(jo) {
            console.log(jo,arguments,"saving bitly data for first time info")
        })
    
    }
    
    function connector_sharing( params, callback, error ) {
        return error({'error' : 'not implemented'});
        
        if(!bitly.user_data.login) {
            console.log('error: no login credentials to send!', params)
            if(error) error({'error' : 'no login credentials to send!'})
            return;
        }
        
        params.login = bitly.user_data.login;
        params.apiKey = bitly.user_data.apiKey;
        // TODO: implement
        // $.connector('/v3/share', params, callback, error)
    }
    
    
    // function connect_upload_screen_captures( image_string_data, callback, error  ) {
    //     if(!bitly.user_data.login) {
    //         if(error) error({'error' : 'no login credentials to send!'})
    //         return;
    //     }
    //     $.connector('/data/upload_screen_capture/', {'screen_grab' : image_string_data,
    //                                     'login' :     bitly.user_data.login,
    //                                     'apiKey' : bitly.user_data.apiKey }, callback, error)
    // }
    
    function connect_get_hashes(hash, callback, error) {
        error({'error' : 'not implemented'});
        if(!bitly.user_data.login) {
            if(error) error({'error' : 'no login credentials to send!'})
            return;
        }
    }
    
    function connect_to_shorten( url, callback, error ) {
        if(!bitly.user_data.login) {
            if(error) error({'error' : 'no login credentials to send!'})
            return;
        }
        $.connector('/v3/shorten', {'longUrl' : url,
                                        'domain' : bitly_data.domain,
                                        'login' : bitly.user_data.login,
                                        'apiKey' : bitly.user_data.apiKey }, callback, error)
    }
    
    function set_tab( shorten_date ) {
        // push onto pages stack for checking later?
        // TODO: cleanup
        var pages, newEntry = true;
        for(var i=0; i<bitly_data.pages.length; i++) {
            pages = bitly_data.pages[i]
            if( pages.hash === shorten_date.hash) {
                newEntry=false;
                break;
            }
        }
        if(newEntry) bitly_data.pages.push( shorten_date  )
    }
</script>

</body>