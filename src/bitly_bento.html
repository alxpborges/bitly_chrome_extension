<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <title>bit.ly Shorten, Share &amp; Track </title>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta name="keywords" content="" />
        <meta name="description" content="" />
        
        <link rel="stylesheet" href="css/bitly_basic.css" type="text/css" charset="utf-8" />
        <link rel="stylesheet" href="css/bitly_bento.css" type="text/css" charset="utf-8" />
        <link rel="shortcut icon" type="image/png" href="http://bit.ly/s/v83/graphics/favicon.ico" /> 
        <style type="text/css" media="screen">
            body {
                min-width:520px;
                min-height:150px;
                position:relative;
            }
        </style>
        
    </head>
    <body>
        <div id="container">
            <!-- Put Content Here -->
            
            <div id="top">

            </div> <!-- end #top -->
            
            <div id="middle">

                  <div id="ext_bento" class="popupContainer">


                      <!-- <div class="bento_actions_buttom" id="captureAndUpload">
                          <a href="#">Cature Screen &amp; Upload</a>
                      </div> -->
                      <!-- <div id="activity_container">

                          <div id="localHistory">
                              <a class="largePromoButton" href="#">Recent Activity</a>
                              <span id="currentSpeed">0 clicks on last 0 links</span>
                              <div class="hr"><hr /></div>
                          </div>  
                                                          
                          <div>

                          </div>
                          <div class="hr"><hr /></div>                                  
                      </div> -->

                      <div id="ext_bento_inner">
                          <form action="#" id="bitly_bento_submit" method="get" accept-charset="utf-8">
                              
                              <div class="bentoShareBoxContainer">
                                  <textarea id="bento_share" name="bento_share"></textarea>                                
                                  <div id="loading_short_url">loading...</div>
                              </div>




                              <div id="bento_action">

                                  <div class="controlsButtonBox">
                                      <input class="disabledState wideSizeButton" type="submit" name="sharing" value="Sign In"     id="some_name" />                                    
                                  </div>

                                  <div id="sharing_active">
                                        <img src="/s/graphics/small_blue_bg_4_segment_loader.gif" width="20" height="20" border="0" alt="" />
                                  </div>


                                  <div class="hr"><hr /></div>
                              </div>

                              <div id="bento_list_items">
                                    <span id="text_counter">140</span>
                                  <div class="hr"><hr /></div>                                
                              </div>

                              <!-- this makes the box work with the 
                                      button box: #bento_action floated right, with is common -->
                              <div class="hr"><hr /></div>
                          </form>                        

                      </div>





                                             
                      <div id="bento_bottom_left">
                          <!-- <div id="imageButtonBox">
                              <a class="pageCaptureImagesButton" href="#">1 image available</a>                            
                          </div> -->

                      </div>
                      
                      <div id="bento_bottom_right">
                          <div id="bento_cover">
                            <!-- this is a hack to cover up part of the shadow blur -->
                          </div>
                          <div class="bento_options_button_container">
                                 <a href="#">Options <span class="bento_options_teaser">(share setup, settings)</span></a>                                                   
                             </div>                            
                      </div>

                  </div> <!-- ? end  #ext_bento -->

                  <div id="bento_bottom">
                      <div id="page_images_viewer">
                          <div id="page_images_viewer_inner">
                              
                          </div>
                          <div class="hr"><hr /></div>
                      </div>
                      <div class="hr"><hr /></div>
                  </div>
               <!-- end #ext_bento_options -->
            </div> <!-- END #middle -->
            <div id="bottom">
                
            </div> <!-- end #bottom -->
        </div> <!-- end #container -->
    
        <script type="text/javascript" src="js/bitly_settings.js" charset="utf-8"></script>    
        <script type="text/javascript" src="js/jquery-1.4.2.js"></script>
        <script type="text/javascript" src="js/plugins/jquery.chunk.js"></script>        
        <script type="text/javascript" src="js/plugins/jquery.errorMessenger.js"></script>
        <script type="text/javascript" src="js/plugins/jquery.commifyNumber.js"></script>            

<script type="text/javascript" charset="utf-8">
    
var STANDARD_HOST = "http://" + bitly_settings.host, 
    page_image_srcs=[], port, shotern_hash_key;  

$(function(){
    var $bod = $(document.body), $text_area = $('#bento_share'), 
    $text_counter = $('#text_counter'),
    active_capturing=false;
    $bod.errorMessenger()  
    // be chatty cathy on open port... 
    // options likes this too..
    
    port = chrome.extension.connect({name: "popup"});                
    port.onMessage.addListener(function(msg) {
        var remote_data = msg.data
        console.log(msg, "message from port", port.name) 
        if(msg.type === "shorten_tab") {
            shotern_hash_key = remote_data.hash;
            $('#loading_short_url').fadeOut('fast');
            var remote_url = remote_data.url || "";
            if(remote_data.share_text.indexOf( remote_url  ) <= 0 && remote_url.length > 0 ) {
                $text_area.val(remote_data.share_text + " " + remote_url);                                                  
            } else {
                $text_area.val(remote_data.share_text);
            }
            setTimeout(function(){
                $text_counter[0].innerText = ( 140 - $.trim( $text_area.val() ).length  )                           
            }, 10)
            
            return;
        }
       
       if(msg.type === "sharing" ) {
           // get from checkbox value instead???
           if(msg) {
               // TODO
               // Add messaging on message success
               if(msg.auto_clear_after_share) { $text_area.val('') }
               $('#sharing_active').css('display', 'none');
               $('.controlsButtonBox').css('display','block')
           }
           return;
       }
       
       // if(msg.type === "shorten_image") {
       //     console.log(msg.data)
       //     var txt = $text_area.val();
       //     txt += " " + msg.data.url
       //     $text_area.val(txt)
       //     $text_area.trigger('keyup')
       //     return;
       // }
       
       // if(msg.type === "recent_metrics") {
       //     if(!msg.click_data) return;
       //     var metric_data = msg.click_data, $cs = $('#currentSpeed'), total_clicks = 0;
       //     for(var i=0; i<metric_data.clicks.length; i++) {
       //         total_clicks += metric_data.clicks[i].user_clicks;
       //     }
       //     
       //     $cs.html( $.commifyNumber(total_clicks) + " clicks on last " + metric_data.pages + " links")
       //     
       //     return;
       // }
       
       if(msg.type === "list_accounts") {
           
           if(msg.data.accounts && msg.data.accounts.length <=0) return;
            var $cbox = $('.controlsButtonBox');
            $cbox.find('input')
                .removeClass('disabledState')
                .addClass('activeButtons').val('Share');
            var html = "";
            var active = 0;
            for(var i=0; i<msg.data.accounts.length; i++) {
                if(msg.data.accounts[i].primary) active += 1;
            }
            html += '<div class="activeAccounts">'+ active +' active</div>'  
            $(html).click(function(e){
                chrome.extension.getBackgroundPage().get_chrome_page("bitly_options.html");                                               
            }).appendTo($cbox);
            
            return;
       }
    });
    
    // run pageload actions
    
    // port.postMessage({type: "list_accounts"});  
    port.postMessage({type: "shorten_tab"});
    // port.postMessage({'type': 'recent_metrics'})                             

    $('.bento_options_button_container a').bind('click', function(e) {
        // open options page....
        e.preventDefault();
        chrome.extension.getBackgroundPage().get_chrome_page("bitly_options.html");                   
        
    })
    
    /*
        Page Button
    */
    // $('#localHistory a').bind('click', function(e) {
    //    e.preventDefault();
    //    // find this thing....
    //    console.log('click on button')  
    //    // open the tab with local history in it...                 
    //     chrome.extension.getBackgroundPage().get_chrome_page("local_history.html");                   
    //    var $this = $(this)
    // });
    
    /*
        Slider:
            Show Current Tab
            
    */
    // var images_distance = 210;
    // $('.pageCaptureImagesButton').toggle(function(e) {
    //     e.preventDefault();
    //     var $this = $(this)
    //     $this.addClass('disabledButtonState')
    // 
    //     chrome.tabs.captureVisibleTab(null, function( image_data ){
    //         var html = '';
    //         html += '<div class="screen_capture_preview_container">'
    //         html+= '<h3>Current Page</h3>'
    //             html += '<div class="page_screen_capture">'
    //                 html += '<img src="'+image_data+'" alt="" border="0" class="screen_capture_preview" />'
    //                 html += '<div class="inActionScreenUpload"></div>'
    //             html+= '</div>'
    //         html += '</div>'
    //         var $pg = $('#page_images_viewer_inner').prepend($(html))
    //         $(document.body).animate({
    //             height : '+='+images_distance+'px'
    //         }, 100, function() {
    //             $pg.slideDown('normal')                        
    //         });                        
    //     });
    //     
    //     build_page_image_viewer( page_image_srcs )                    
    // 
    //    
    // }, function(e) {
    //     e.preventDefault();
    //     var $pg = $('#page_images_viewer_inner');
    // 
    //     $pg.slideUp('normal', function() {
    //        
    //         $(document.body).animate({
    //             height : '-='+images_distance+'px'
    //         }, 100, function(){
    //             $pg.find('*').remove()                            
    //         }); 
    //         
    // 
    //         
    //     })                        
    //  
    //     
    //     
    // });
    // 
    // 
    // $('.screen_capture_preview').live('click', function(e){
    //     e.preventDefault();
    //     if(active_capturing) return;
    //     active_capturing=true;
    //     
    //     
    //     console.log('I hear the click')
    //     var $this = $(this), $w = $this.width(), $h = $this.height(), 
    //         $p = $this.parents('.page_screen_capture'),
    //         params = { 'screen_grab' : $this.attr('src'), 'type' : 'screen_grab' };
    //         console.log('word', $w, $h)
    //         $p.find('.inActionScreenUpload').css({
    //                 'display': 'block',
    //                 'width' : $w,
    //                 'height' : $h
    //             })
    //         
    //     chrome.extension.sendRequest(params, function(jo) {
    //         //$bento_box_elem.trigger('updateTextArea', jo.data);
    //         console.log(jo, "capture")
    //         for(var i=0; i<jo.photos.length; i++) {
    //         
    //             var text_area = $text_area.val();    
    //             text_area += " " + jo.photos[i].MediaUrl
    //             $text_area.val( text_area )
    //             $text_area.trigger('keyup')                            
    //             /*
    //                 todo
    //                 fix this to trigger a different event, or change the bento box, if you 
    //                 don't want these added to the  shortenscomplete list...
    //             */
    //             
    //             //capsule_container.trigger('updateTextArea', {'url' : jo.photos[i].MediaUrl } );
    // 
    //         }
    //         $p.find('.inActionScreenUpload').css({'display': 'none'})                        
    //         active_capturing = false;                        
    // 
    //         $this.removeClass('disabledButtonState')                    
    //     })
    // });
    
    $('#bitly_bento_submit').bind('submit', function(e) {
        e.preventDefault();
        console.log('working....')
        var share_text = $.trim( $text_area.val() );
        if($.trim( share_text ) === ""  || share_text.length > 140 ) return;
        
        $('.controlsButtonBox').css('display','none')
        $('#sharing_active').css('display', 'block');
        
        port.postMessage({type: "sharing", 'share_text' : share_text, 'page_hash' : shotern_hash_key });                     
    });
    
    

    // var clicks_internval = setInterval(function(e) {
    //     
    //     //
    //     port.postMessage({'type': 'recent_metrics'})
    //     
    // }, 30000);
    
    $(document.body).bind('unload', function() {
        clearInterval(clicks_internval)
    })
    
    var update_counter = false, update_timeout;
    $text_area.bind('keyup', function(e) {
        if(update_timeout) clearTimeout(update_timeout);
        update_timeout = setTimeout(function(){
            
            $text_counter[0].innerText = ( 140 - $.trim( $text_area.val() ).length  )                           
        }, 10)
    })
    
    
    chrome.tabs.getSelected(null, function(curr_tab) {   
        console.log('found tab,', curr_tab.id)  
        //curr_tab.id
        // TODO
        // hard coding to make this easier   
        // this will break!     
        // var text_area = $text_area.val();    
        // text_area += " " + curr_tab.id                        
        // $text_area.val( text_area );
                                   
        //curr_tab.id = 698;
        var page_port = chrome.tabs.connect( curr_tab.id, {'name' : 'images' }  );
        console.log(page_port)

        
        page_port.onMessage.addListener(function( message ){                
            console.log(message, "the page said this")
                
           //build_page_image_viewer( message.image_elements )
           // $('.pageCaptureImagesButton').html((message.image_elements.length+1) + " images available")
           //  page_image_srcs = message.image_elements;

        });

        // setTimeout(function() {
        //     page_port.postMessage({"action" : "images"})                        
        // }, 60)
        

    });                

    
})



function checkClicks() {
    /*
        get the last 5 local hashes..
        call the 
    */
}


// function build_page_image_viewer( img_elems ) {
//     var $imgs;
//     
//     var html = '<div class="page_image_container">';
//     if( img_elems.length > 0) {
//         html += '<h3 class="pageImagesHeader">Images on Page</h3>'
//         html += '<div class="page_image_container_inner">'                    
//     } 
//             
// 
//     //var images = $.chunk(img_elems, 4)
//     //var image_srcs = images[0]
//         for(var i=0; i<img_elems.length; i++) {
//         
//             html += '<div class="page_image_container_single">'
//             html+= '<img src="' + img_elems[i] + '" alt="0" class="page_image_container_single_img" />'
//                 html+= '<div style="display:none;" class="page_image_hover_display">'
//                     html+= '<img src="' + img_elems[i] + '" alt="0" />'                        
//                 html += '</div>'
//             html += '</div>'
//         }
// 
//         html += '</div>'
// 
//     html += '</div>'
//         html += '<div class="hr"><hr /></div>'                    
//     //html += '<div><a href="">Up</a><a href="">Down</a></div>'
//     $imgs = $(html);
//     //var $img = $('<img />').attr('src', message.image_elements[4] );
//     var $pg = $('#page_images_viewer_inner').append($imgs)
//     
//     
//     // .hover(function(e){
//     //     var $this = $(this), $p = $this.parents('.page_image_container_single')
//     //     $p.find('.page_image_hover_display').css('display','block')
//     // }, function(e) {
//     //     // unhover
//     //     var $this = $(this), $p = $this.parents('.page_image_container_single')
//     //     $p.find('.page_image_hover_display').css('display','none    ')                    
//     // })                
//     
//     
//     $pg.find('.page_image_container_single_img').click(function(e) {
//         var $this = $(this);
//         //var $enlarge = $this.clone();
//         $this.addClass('shortenedPageImage')
//         //$this.attr('src')
//         // clone this.
//         port.postMessage({"type" : "shorten_image", "data" : { 
//                 'page_hash' : shotern_hash_key, 
//                 'url' : $this.attr('src') } })
//         });
// 
// 
// 
//     //             
//     // $('#middle').animate({
//     //     'marginLeft' : '+=200px'
//     // }, 200, function() {
//     //     // $('#pageImagesViewer').animate({
//     //     //     
//     //     // })
//     //     //$('#pageImagesViewer').css('display', 'block')    
//     //     
//     // })
// 
//     // $(document.body).css('paddingLeft', 150)
//     // 
//     // $('.popupColumnLeft').animate({
//     //     'width' :'100px'
//     // }, 150, function() {
//     //     $('#pageImagesViewer').css('display', 'block')                                   
//     // })
// 
//     
//     /*
//         Essentianlly:
//             1. get images from page,
//             2. show two - 4 images at a time on the right (maybe more if options panel is open... check docoument heigt)
//             3. allow users to flip throw images in sets of N (paging)
//             4. show how many images avail
//                 5. let user 'select' an image - upload that image src to tweet photo somehow... get the file src?
//             
//             5. let user shorten link to this image... and add to text area... shortened
//     */
//     
// }


</script>
             
     
    </body>
</html>
